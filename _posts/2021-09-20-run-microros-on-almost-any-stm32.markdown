---
layout: post
title:  "Run micro-ros on almost any stm32"
date:   2021-09-20 00:00:00 +0700
categories: [c, cmake, stm32, micro-ros, clion]
image: Broadcast_Mail.png
---

Micro-ros brings the ability to integrate micro-controllers into the ROS ecosystem. Having microcontrollers publishing topic directly into your ros2 host could facilitate a lot the integration. So far micro-ros is only officially supporting a small amount of boards. Unforthunlty I didn't have any stm32 boad supported officially supported by micro-ros so I decided to have a look at how to run micro ros on the stm32 board I had at home. So I have a Nucleo-L476RG which is a ultra low power board. It has a lot of pins and configuration possibility, a Flash size of 1MB and two RAMs (96 KB and 32 KB). In my case I am going to use the UART to transmit my data (using the debugger UART to avoid additional wiring). Basically what we are going to do is that we are going to create a project with CUBEMX, configure it and adapt the CMakeLists in order to link with the static micro-ros library. In my case I will use clion as an IDE but most of the CMake-compatible IDE should work (Clion has a nice stm32 plugins that facilitates a lot of things). Micro-ros is not already exepcting you to use CMake, it's rather using plain Makefiles. But with just a few change we will be able to use cmake.

### Install all you need
-----
In this post I am on ubuntu 20.04 with ros2 foxy already installed.

#### Micro ROS setup

Clone this repo <https://github.com/micro-ROS/micro_ros_setup/tree/foxy> and follow the instruction in order to build the micro-ros agent (interface between the UART and ROS2). For some reason every script in this repo have a carriage-return character at the end of every lines. In order to run it on Linux you can run `find . -type f -print0 | xargs -0 dos2unix` in order to convert all the files.
#### Micro_ros_stm32cubemx_utils
In order to generate the static library we are going to need another repo micro_ros_stm32cubemx_utils <https://github.com/micro-ROS/micro_ros_stm32cubemx_utils/tree/foxy>. 
For this example this repo as well as the CubeMX project are going to be located in one directory.
{% highlight bash %}
.
├── l476rg_test   # The CubeMX project explained right after
└── micro_ros_stm32cubemx_utils # the repo
{% endhighlight %}

-----

### Generate your project with CubeMX

#### UART

Within CubeMX I generated a project for my board: Nucleo-476RG. I activate the USART2 (the one connected to the debugger). Configure it for asynchronous and disable hardware control.
![UART2 setup](/static/img/posts/Run_micro-ros_on_almost_any_stm32/UART_configuration.png "UART2 setup")
I left the default basic setup of it (115200 Bits/s, 8 Bits, None, 1). Check the "Global interrupt" checkbox under the NVIC Settings.
![NVIC settings](/static/img/posts/Run_micro-ros_on_almost_any_stm32/nvic_settings.png "NVIC settings")
Make sure to enable to DMA for the corresponding UART. Both priorities must be set to very hight and RX direction must be set to Peripheral To Memory and TX one to Memory to Peripheral. Please also make sure that RX DMA Request settings Mode is set to Circular (Keep the Normal on for TX).
![DMA setup](/static/img/posts/Run_micro-ros_on_almost_any_stm32/DMA.png "DMA setup")

#### FreeRTOS
For our example we will need FreeRTOS. We will simply need to configure a task (the default) for micro-ros. Activate FreeRTOS in CubeMX (I used CMSIS v2). Micro-ros will need at least 12kB for it's task hence we need to increase the default TOTAL_HEAP_SIZE of FreeRTOS. I picked 20000 bytes for my test (but you can of course use 12000).
![FreeRTOS setup](/static/img/posts/Run_micro-ros_on_almost_any_stm32/freertos.png "FreeRTOS setup")
You must also create a task for you micro-ros. We are simply going to use the default one. And set a size of 3000 words (3000 words of 4 bytes is 12kB).
![FreeRTOS task setup](/static/img/posts/Run_micro-ros_on_almost_any_stm32/freertos_task.png "FreeRTOS task setup")
#### Generate the project
Here I want to use clion with cmake hence I am going to generate my project for the SW4STM32 toolchain : Project Manage -> Project -> Toolchain / IDE; and select SW4STM32. Generate code in order to have the source files as well as the CMakeLists.txt.
-----
### Generate the Micro-ros static library
Here we are going to use the micro_ros_stm32cubemx_utils repo that we donwloaded before. This repository is using the makefiles to extract the compilation flags in order to build the micro-ros static library. Unfortunatly so far it's only extracting from files with .mk extension and in our case the file containing the flags (generated by cmake) is called `flags.make`. Thus we will have to make a little change to the repo. We will change the file microros_static_library_ide/library_generation/library_generation.sh by adding `[a]` and `[e]` line 13:
{% highlight git %}
@@ -10,7 +10,7 @@ if [ -f "$BASE_PATH/libmicroros/libmicroros.a" ]; then
     exit 0
 fi
 ######## Trying to retrieve CFLAGS ########
-export RET_CFLAGS=$(find /project -type f -name *.mk -exec cat {} \; | python3 $BASE_PATH/library_generation/extract_flags.py)
+export RET_CFLAGS=$(find /project -type f -name *.m[a]k[e] -exec cat {} \; | python3 $BASE_PATH/library_generation/extract_flags.py)
 RET_CODE=$?
 
 if [ $RET_CODE = "0" ]; then
 {% endhighlight %}

 Once it's done, from the directory containing the CubeMX project and the micro_ros_stm32cubemx_utils repo, launch
 {% highlight bash %}
 docker pull microros/micro_ros_static_library_builder:foxy &&\
  docker run --rm -v ${PWD}:/project --env MICROROS_LIBRARY_FOLDER=micro_ros_stm32cubemx_utils/microros_static_library_ide microros/micro_ros_static_library_builder:foxy`
 {% endhighlight %}
 You should see the list of CFLAGS detected. In my case:
{% highlight bash %}
 Found CFLAGS:
-------------
-ffunction-sections -fdata-sections -mcpu=cortex-m4 -mfpu=fpv4-sp-d16 -mfloat-abi=hard -mthumb -Og
-------------
{% endhighlight %}
This will take some time and after in 

### Use the library


_If you have any suggestion/question/remark please don't hesitate to leave a comment._
